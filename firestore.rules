rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users Collection
    // Users can only read/write their own user document
    match /users/{userId} {
      // Allow read if user is authenticated and owns the document
      allow read: if isOwner(userId);
      
      // Allow create if user is authenticated and creating their own document
      allow create: if isAuthenticated() && 
                       request.auth.uid == userId &&
                       request.resource.data.id == userId &&
                       request.resource.data.keys().hasAll(['id', 'fullName', 'email', 'createdAt']);
      
      // Allow update if user owns the document
      allow update: if isOwner(userId) &&
                       resource.data.id == userId;
      
      // Allow delete if user owns the document (optional - usually not needed)
      allow delete: if isOwner(userId);
    }
    
    // Password Reset Codes Collection
    // Allow public access for forgot password flow
    match /password_reset_codes/{email} {
      // Allow anyone to create a reset code (for forgot password flow)
      allow create: if true;
      
      // Allow anyone to read (needed to verify code during reset)
      allow read: if true;
      
      // Allow update only to mark as used (when code is consumed)
      allow update: if true;
      
      // Don't allow delete
      allow delete: if false;
    }
    
    // Notes Collection
    // Users can only access their own notes
    match /notes/{noteId} {
      // Allow read if user owns the note
      allow read: if isAuthenticated() && 
                     resource.data.ownerId == request.auth.uid;
      
      // Allow create if user is authenticated and setting themselves as owner
      allow create: if isAuthenticated() &&
                       request.resource.data.ownerId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['id', 'ownerId', 'title', 'createdAt', 'updatedAt']);
      
      // Allow update if user owns the note
      allow update: if isAuthenticated() &&
                       resource.data.ownerId == request.auth.uid &&
                       request.resource.data.ownerId == resource.data.ownerId;
      
      // Allow delete (soft delete by setting deletedAt) if user owns the note
      allow delete: if isAuthenticated() &&
                       resource.data.ownerId == request.auth.uid;
    }
  }
}
